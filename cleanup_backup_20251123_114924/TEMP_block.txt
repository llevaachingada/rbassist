    if st.button("Add Folder"):
        st.session_state.show_add_modal = True
    if st.session_state.get("show_add_modal"):
        with st.modal("Add Music Folder"):
            folder = st.text_input("Folder path", value="")
            modes = ["baseline", "stems"]
            idx = 0 if st.session_state.last_mode == "baseline" else 1
            mode = st.radio("Analysis mode", modes, index=idx, horizontal=True)
            c1, c2 = st.columns(2)
            with c1:
                if st.button("Cancel"):
                    st.session_state.show_add_modal = False
            with c2:
                if st.button("Add"):
                    p = pathlib.Path(folder).expanduser()
                    if not p.exists():
                        st.warning("Folder does not exist.")
                    else:
                        set_folder_mode(str(p), mode)
                        st.session_state.last_mode = mode
                        if mode == "stems":
                            import shutil
                            if shutil.which("demucs") is None:
                                st.warning("Demucs not found—stems will be skipped until installed.")
                        st.success("Saved. New scans will honor this mode.")
                        st.session_state.show_add_modal = False
                        st.experimental_rerun()


col1, col2, col3, col4 = st.columns(4)

with col1:
    if st.button("Embed (incremental)"):
        files = list_audio(root)
        if limit and limit > 0:
            files = files[: int(limit)]
        with st.status("Embedding…", expanded=True) as status:
            st.write(f"Found {len(files)} files")
            build_embeddings(files, duration_s=int(duration))
            status.update(label="Embeddings complete", state="complete")

with col2:
    if st.button("Analyze BPM/Key"):
        files = list_audio(root)
        if limit and limit > 0:
            files = files[: int(limit)]
        with st.status("Analyzing BPM/Key…", expanded=True) as status:
